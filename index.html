<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Pete WebAR (MindAR) — Debug</title>
  <style>
    html,body{margin:0;padding:0;height:100%;background:#000;}
    #ar-container{position:fixed;inset:0;}
    #gate,#hud{position:fixed;left:0;top:0;right:0;z-index:10;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    #gate{bottom:0;display:flex;flex-direction:column;justify-content:center;align-items:center;background:linear-gradient(180deg,rgba(0,0,0,.2),rgba(0,0,0,.85));color:#fff;padding:24px;gap:16px;text-align:center;}
    .btn{appearance:none;border:0;border-radius:999px;padding:14px 18px;font-weight:700;letter-spacing:.2px;}
    .btn-primary{background:#cc0000;color:#fff;}
    .btn-primary:active{transform:scale(.98);}
    #hud{pointer-events:none;}
    #cta-wrap{position:fixed;bottom:16px;left:0;right:0;display:flex;justify-content:center;gap:12px;}
    #cta-wrap a{pointer-events:auto;text-decoration:none;background:#ffffffee;color:#000;border-radius:999px;padding:12px 16px;font-weight:700;}
    #subtitle{position:fixed;bottom:76px;left:12px;right:12px;pointer-events:none;background:rgba(0,0,0,.55);color:#fff;padding:8px 12px;border-radius:12px;text-align:center;font-size:14px;}
    #debug{position:fixed;top:8px;left:8px;color:#fff;font-size:12px;opacity:.95;background:rgba(0,0,0,.4);padding:6px 8px;border-radius:8px;white-space:pre-line;max-width:92vw;}
  </style>

  <!-- Libraries with fallbacks (order matters) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js" crossorigin="anonymous"
          onerror="this.onerror=null;this.src='https://unpkg.com/three@0.152.2/build/three.min.js'"></script>

  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.js" crossorigin="anonymous"
          onerror="this.onerror=null;this.src='https://unpkg.com/three@0.152.2/examples/js/loaders/GLTFLoader.js'"></script>

  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js" crossorigin="anonymous"
          onerror="this.onerror=null;this.src='https://unpkg.com/mind-ar@1.2.5/dist/mindar-image-three.prod.js'"></script>
</head>
<body>
  <div id="ar-container"></div>

  <!-- Start gate -->
  <div id="gate">
    <img src="./assets/marker.jpg" alt="Scan Marker" style="width:120px;height:auto;border-radius:8px;border:1px solid #333;opacity:.95"/>
    <div style="max-width:380px">Move your phone to detect the poster, then tap start to place Pete. Audio will play.</div>
    <button id="startBtn" class="btn btn-primary">Start AR</button>
  </div>

  <!-- HUD -->
  <div id="hud" style="display:none">
    <div id="subtitle">Welcome home, Penguins — Pete here. Tap the link to follow @ysu_hrl.</div>
    <div id="cta-wrap">
      <a href="https://www.instagram.com/ysu_hrl/" target="_blank" rel="noopener">Follow @ysu_hrl</a>
    </div>
    <div id="debug">Ready</div>
  </div>

  <audio id="voice" src="./assets/pete-voice.mp3" preload="auto"></audio>

  <script>
    // ===== Debug helpers =====
    const debugEl = document.getElementById('debug');
    function log(msg){ debugEl.textContent = (debugEl.textContent ? debugEl.textContent + "\n" : "") + msg; }

    window.onerror = function(message, source, lineno, colno, error){
      log("JS Error: " + message);
    };
    window.addEventListener('unhandledrejection', (e)=>{
      log("Promise rejection: " + (e.reason && e.reason.message ? e.reason.message : String(e.reason)));
    });

    // ===== Library wait =====
    function waitForLibs(maxMs=15000){
      const start = Date.now();
      return new Promise((resolve, reject)=>{
        (function poll(){
          const ok = !!(window.THREE && window.THREE.GLTFLoader &&
                        window.MINDAR && window.MINDAR.IMAGE &&
                        window.MINDAR.IMAGE.MindARThree);
          if (ok) return resolve();
          if (Date.now()-start > maxMs) return reject(new Error('MindAR/THREE libs failed to load'));
          setTimeout(poll, 80);
        })();
      });
    }

    // ===== Camera preflight =====
    async function requestCameraPreflight(){
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        throw new Error('Camera API not available in this browser');
      }
      const tempStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      tempStream.getTracks().forEach(t => t.stop());
    }

    // ===== Main =====
    (function(){
      const startBtn=document.getElementById('startBtn');
      const gate=document.getElementById('gate');
      const hud=document.getElementById('hud');
      const subtitle=document.getElementById('subtitle');
      const voice=document.getElementById('voice');

      const captions=[
        {t:0.1,text:"Welcome home, Penguins — Pete here."},
        {t:3.4,text:"Tap the link to follow @ysu_hrl."},
        {t:6.2,text:"Get event drops, RA shout-outs, and housing updates."}
      ];
      function runCaptions(){
        let i=0; const timer=setInterval(()=>{
          const t=voice.currentTime;
          if(i<captions.length && t>=captions[i].t){ subtitle.textContent=captions[i].text; i++; }
          if(voice.ended || t>=(voice.duration||9.5)) clearInterval(timer);
        },100);
      }

      // Status when page loads
      window.addEventListener('load', ()=>{
        const okThree=!!window.THREE;
        const okLoader=!!(window.THREE && window.THREE.GLTFLoader);
        const okMind=!!(window.MINDAR && window.MINDAR.IMAGE && window.MINDAR.IMAGE.MindARThree);
        debugEl.textContent = `THREE:${okThree?'OK':'X'} Loader:${okLoader?'OK':'X'} MindAR:${okMind?'OK':'X'}`;
      });

      startBtn.addEventListener('click', async ()=>{
        log("Start clicked");
        hud.style.display='block';
        gate.style.display='none';

        try{ await voice.play(); voice.pause(); voice.currentTime=0; log("Audio unlocked"); }catch(e){ log("Audio unlock failed (OK to continue)"); }

        try{ await waitForLibs(); log("Libs: OK"); }
        catch(err){ log("Error loading libs: "+err.message); return; }

        try{
          log("Requesting camera…");
          await requestCameraPreflight();
          log("Camera: OK");
        }catch(e){
          log("Camera error: "+(e.name||'')+(e.message?(' — '+e.message):''));
          log("Tips: iPhone Safari → Settings > Safari > Camera > Allow. Android Chrome → Settings > Site settings > Camera > Allow.");
          return;
        }

        // MindAR init
        log("Starting MindAR…");
        const mindarThree=new window.MINDAR.IMAGE.MindARThree({
          container: document.querySelector('#ar-container'),
          imageTargetSrc: './assets/targets.mind',
          uiLoading:false, uiError:true, maxTrack:1
        });
        const {renderer,scene,camera}=mindarThree;
        scene.add(new THREE.HemisphereLight(0xffffff,0x222222,1.1));

        const anchor=mindarThree.addAnchor(0);
        const loader=new THREE.GLTFLoader();
        loader.load('./assets/pete.glb',(gltf)=>{
          log("GLB loaded");
          const pete=gltf.scene;
          pete.scale.set(0.8,0.8,0.8);
          pete.position.set(0,-0.1,0);
          pete.rotation.set(0,Math.PI,0);
          anchor.group.add(pete);

          if(gltf.animations && gltf.animations.length){
            const mixer=new THREE.AnimationMixer(pete);
            const action=mixer.clipAction(gltf.animations[0]); action.play();
            const clock=new THREE.Clock();
            renderer.setAnimationLoop(()=>{ mixer.update(clock.getDelta()); renderer.render(scene,camera); });
          } else {
            renderer.setAnimationLoop(()=>{ renderer.render(scene,camera); });
          }

          anchor.onTargetFound=()=>{ try{ voice.currentTime=0; voice.play(); runCaptions(); log("Marker found → speaking"); }catch(e){} };
        }, undefined, (err)=>{ log('GLB load error (check assets/pete.glb)'); });

        try{
          await mindarThree.start();
          log('Tracking… point at the poster.');
        }catch(e){
          log('MindAR start error: '+e.message);
        }
      });
    })();
  </script>
</body>
</html>
