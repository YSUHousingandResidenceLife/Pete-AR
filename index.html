<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Pete WebAR (MindAR A-Frame, Stable)</title>
  <style>
    html,body{margin:0;padding:0;height:100%;background:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    #gate,#hud{position:fixed;left:0;right:0;z-index:10}
    #gate{top:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
          background:linear-gradient(180deg,rgba(0,0,0,.2),rgba(0,0,0,.85));color:#fff;gap:16px;padding:24px;text-align:center}
    .btn{appearance:none;border:0;border-radius:999px;padding:14px 18px;font-weight:700;letter-spacing:.2px;background:#cc0000;color:#fff}
    #hud{pointer-events:none}
    #cta{position:fixed;bottom:16px;left:0;right:0;display:flex;justify-content:center}
    #cta a{pointer-events:auto;text-decoration:none;background:#ffffffee;color:#000;border-radius:999px;padding:12px 16px;font-weight:700}
    #debug{position:fixed;top:8px;left:8px;color:#fff;font-size:12px;background:rgba(0,0,0,.4);padding:6px 8px;border-radius:8px;white-space:pre-line}
  </style>

  <!-- Use your local libs (A-Frame 1.4.1 content in aframe.min.js; MindAR 1.2.5 A-Frame build) -->
  <script src="./libs/aframe.min.js"></script>
  <script src="./libs/mindar-image-aframe.prod.js"></script>
</head>
<body>
  <!-- Start gate (unlocks audio on mobile) -->
  <div id="gate">
    <img src="./assets/marker.jpg" alt="Scan Marker" style="width:120px;height:auto;border-radius:8px;border:1px solid #333;opacity:.95"/>
    <div style="max-width:380px">Move your phone to detect the poster, then tap Start to see Pete. Audio will play.</div>
    <button id="startBtn" class="btn" disabled>Loading…</button>
  </div>

  <!-- HUD -->
  <div id="hud" style="display:none">
    <div id="debug">Ready</div>
    <div id="cta"><a href="https://www.instagram.com/ysu_hrl/" target="_blank" rel="noopener">Follow @ysu_hrl</a></div>
  </div>

  <!-- Pete audio -->
  <audio id="voice" src="./assets/pete-voice.mp3" preload="auto"></audio>

  <!-- A-Frame / MindAR scene -->
  <a-scene
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="colorManagement: true, physicallyCorrectLights: true"
    embedded
    mindar-image="imageTargetSrc: ./assets/targets.mind; maxTrack: 1;"
    id="scene">

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-gltf-model id="pete"
        src="./assets/pete.glb"
        position="0 -0.1 0"
        rotation="0 180 0"
        scale="0.8 0.8 0.8">
      </a-gltf-model>

      <a-entity light="type: hemisphere; intensity: 1.1; groundColor: #222"></a-entity>
    </a-entity>
  </a-scene>

  <script>
    const gate = document.getElementById('gate');
    const hud  = document.getElementById('hud');
    const debugEl = document.getElementById('debug');
    const voice = document.getElementById('voice');
    const scene = document.getElementById('scene');
    const startBtn = document.getElementById('startBtn');

    function log(msg){ debugEl.textContent = msg; }

    // Enable Start only after the A-Frame scene is fully initialized
    scene.addEventListener('loaded', ()=>{
      startBtn.textContent = 'Start';
      startBtn.disabled = false;
    });

    // Speak when the marker is found
    scene.addEventListener("targetFound", ()=>{
      try { voice.currentTime = 0; voice.play(); } catch(_) {}
      log("Marker found → speaking");
    });
    scene.addEventListener("targetLost", ()=>{ log("Marker lost"); });

    // Extra diagnostics: can the browser even see a camera?
    async function canSeeAnyCamera(){
      if (!navigator.mediaDevices?.enumerateDevices) return true; // not supported → don't block
      try{
        const list = await navigator.mediaDevices.enumerateDevices();
        const cams = list.filter(d => d.kind === 'videoinput');
        return cams.length > 0;
      }catch{ return true; }
    }

    startBtn.addEventListener('click', async ()=>{
      hud.style.display = 'block';
      gate.style.display = 'none';

      // unlock audio on mobile
      try { await voice.play(); voice.pause(); voice.currentTime = 0; } catch(_) {}

      // quick hardware check
      if (!(await canSeeAnyCamera())){
        log("No camera detected on this device/user profile.");
        return;
      }

      // request camera once to trigger permission UI
      if (navigator.mediaDevices?.getUserMedia) {
        try {
          const s = await navigator.mediaDevices.getUserMedia({video:true});
          s.getTracks().forEach(t=>t.stop());
        } catch (e) {
          log("Camera blocked — enable camera for this site in browser settings.\nTips:\n• iPhone Safari: aA ▸ Website Settings ▸ Camera ▸ Allow\n• Android Chrome: lock icon ▸ Permissions ▸ Camera ▸ Allow");
          return;
        }
      }

      // start AR (after scene loaded)
      try {
        await scene.systems["mindar-image-system"].start();
        log("Tracking… point at the poster.");
      } catch (e) {
        log("Failed to start AR: " + (e.message || e));
      }
    });
  </script>
</body>
</html>
