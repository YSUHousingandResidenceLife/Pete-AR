<script>
  /* ... keep everything above this line (camera setup etc.) ... */

  // --- Sticker transforms: DRAG (1 finger), PINCH+ROTATE (2 fingers) ---
  let originX = 50, originY = 55;   // sticker anchor in %
  let scale = 1, rotation = 0;      // current transform
  let activePointers = new Map();

  // For drag baseline
  let dragStartX = 0, dragStartY = 0;

  // For pinch/rotate baseline
  let baseDistance = null, baseAngle = null;

  function renderSticker() {
    sticker.style.left = originX + '%';
    sticker.style.top  = originY + '%';
    sticker.style.transform = `translate(-50%,-50%) rotate(${rotation}deg) scale(${scale})`;
  }

  function pointerDown(e) {
    activePointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
    sticker.setPointerCapture(e.pointerId);
    // record drag start for 1-finger moves
    dragStartX = e.clientX;
    dragStartY = e.clientY;

    // if we now have two pointers, set pinch/rotate baselines
    if (activePointers.size === 2) {
      const pts = [...activePointers.values()];
      baseDistance = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
      baseAngle    = Math.atan2(pts[1].y - pts[0].y, pts[1].x - pts[0].x);
    }
  }

  function pointerMove(e) {
    if (!activePointers.has(e.pointerId)) return;
    activePointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

    const stageRect = document.getElementById('stage').getBoundingClientRect();

    if (activePointers.size === 1) {
      // --- DRAG (1 finger) ---
      const dx = e.clientX - dragStartX;
      const dy = e.clientY - dragStartY;

      originX = Math.min(100, Math.max(0, originX + (dx / stageRect.width)  * 100));
      originY = Math.min(100, Math.max(0, originY + (dy / stageRect.height) * 100));

      dragStartX = e.clientX;
      dragStartY = e.clientY;

    } else if (activePointers.size === 2) {
      // --- PINCH + ROTATE (2 fingers) ---
      const pts = [...activePointers.values()];
      const dist = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
      const ang  = Math.atan2(pts[1].y - pts[0].y, pts[1].x - pts[0].x);

      if (baseDistance) {
        const factor = dist / baseDistance;
        scale = Math.min(2.0, Math.max(0.5, scale * factor));
        baseDistance = dist; // update baseline for smoothness
      }
      if (baseAngle !== null) {
        rotation += ((ang - baseAngle) * 180 / Math.PI) / 2; // less sensitive rotate
        baseAngle = ang; // update baseline
      }

      // keep UI in sync
      scaleRange.value  = scale.toFixed(2);
      rotateRange.value = rotation.toFixed(0);
    }

    renderSticker();
  }

  function pointerUp(e) {
    activePointers.delete(e.pointerId);
    sticker.releasePointerCapture(e.pointerId);
    // if we drop below 2 touches, reset pinch/rotate baselines
    if (activePointers.size < 2) { baseDistance = null; baseAngle = null; }
  }

  sticker.addEventListener('pointerdown',  pointerDown);
  sticker.addEventListener('pointermove',  pointerMove);
  sticker.addEventListener('pointerup',    pointerUp);
  sticker.addEventListener('pointercancel',pointerUp);
  sticker.addEventListener('pointerleave', pointerUp);

  // Sliders still work
  scaleRange.addEventListener('input', e => { scale = parseFloat(e.target.value); renderSticker(); });
  rotateRange.addEventListener('input', e => { rotation = parseFloat(e.target.value); renderSticker(); });

  /* ... keep everything below this line (Capture code etc.) ... */
</script>
